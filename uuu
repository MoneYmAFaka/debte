-- Star & Enemy Farm - FIXED Auto TP (Mobs + MobSpawns) + Mobile Scroll
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Star & Enemy Farm - TP FIXED",
    Author = "by Fry",
    Icon = "solar:star-bold",
    Theme = "MonokaiPro",
    NewElements = true,
    Transparent = true,
    Acrylic = true,
    Size = UDim2.new(0, 460, 0, 760),  -- Tall for mobile scroll
})
Window:Open()

local Main = Window:Tab({Title = "Main", Icon = "solar:cart-large-bold"})
Main:Select()

-- ==================== MOBILE SCROLL FIX ====================
task.spawn(function()
    task.wait(0.5)
    pcall(function()
        local scroller = Main:FindFirstChildWhichIsA("ScrollingFrame", true)
        if scroller then
            scroller.ScrollingEnabled = true
            scroller.ScrollBarThickness = 10
            scroller.AutomaticCanvasSize = Enum.AutomaticSize.Y
        end
    end)
end)

-- ==================== REMOTES ====================
local Knit = game:GetService("ReplicatedStorage"):WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_knit@1.5.1"):WaitForChild("knit")
local ClickRemote     = Knit:WaitForChild("Services"):WaitForChild("ClickService"):WaitForChild("RF"):WaitForChild("Click")
local OpenStarRemote  = Knit:WaitForChild("Services"):WaitForChild("StarService"):WaitForChild("RF"):WaitForChild("OpenStar")

local StarsFolder   = game:GetService("ReplicatedStorage").Assets.Models.Stars
local EnemiesFolder = game:GetService("ReplicatedStorage").Assets.Models.Enemies   -- for dropdown templates

local selectedStar   = nil
local selectedEnemy  = nil
local autoClicking   = false
local autoHatching   = false
local autoTeleporting = false
local hatchAmount    = 1

local function GetStars()
    local list = {}
    for _, v in ipairs(StarsFolder:GetChildren()) do
        if v:IsA("Model") then table.insert(list, v.Name) end
    end
    table.sort(list)
    return list
end

-- ==================== FIXED TELEPORT (searches Mobs + MobSpawns) ====================
local function FindNextAliveEnemy()
    if not selectedEnemy then return nil end
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    local root = char.HumanoidRootPart
    local best, bestDist = nil, math.huge

    -- 1. Check workspace.Mobs first (live enemies)
    local mobsFolder = workspace:FindFirstChild("Mobs")
    if mobsFolder then
        for _, obj in ipairs(mobsFolder:GetDescendants()) do
            if obj:IsA("Model") and obj.Name == selectedEnemy then
                local hum = obj:FindFirstChild("Humanoid")
                local hrp = obj:FindFirstChild("HumanoidRootPart")
                if hum and hum.Health > 0 and hrp then
                    local dist = (hrp.Position - root.Position).Magnitude
                    if dist < bestDist then bestDist = dist best = obj end
                end
            end
        end
    end

    -- 2. Check workspace.MobSpawns (sometimes mobs spawn here)
    local spawnFolder = workspace:FindFirstChild("MobSpawns")
    if spawnFolder and not best then
        for _, obj in ipairs(spawnFolder:GetDescendants()) do
            if obj:IsA("Model") and obj.Name == selectedEnemy then
                local hum = obj:FindFirstChild("Humanoid")
                local hrp = obj:FindFirstChild("HumanoidRootPart")
                if hum and hum.Health > 0 and hrp then
                    local dist = (hrp.Position - root.Position).Magnitude
                    if dist < bestDist then bestDist = dist best = obj end
                end
            end
        end
    end

    return best
end

local function TeleportTo(enemyModel)
    if not enemyModel then return end
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local root = char.HumanoidRootPart
    local targetRoot = enemyModel:FindFirstChild("HumanoidRootPart") or enemyModel:GetPivot()
    root.CFrame = targetRoot * CFrame.new(0, 15, 10)  -- safer height & distance
end

-- ==================== AUTO CLICK ====================
Main:Section({Title = "Auto Click (Attacking)"})
Main:Toggle({
    Title = "Auto Click",
    Callback = function(v)
        autoClicking = v
        if v then
            task.spawn(function()
                while autoClicking do
                    pcall(ClickRemote.InvokeServer, ClickRemote)
                    task.wait(0.08)
                end
            end)
        end
    end,
})

-- ==================== STAR HATCHING ====================
Main:Section({Title = "Star Hatching"})
local starDrop = Main:Dropdown({
    Title = "Select Star",
    Values = GetStars(),
    SearchBarEnabled = true,
    Callback = function(v) selectedStar = v end,
})

Main:Button({Title = "Refresh Stars", Callback = function() starDrop:Refresh(GetStars()) end})

Main:Slider({
    Title = "Hatch Amount",
    Value = {Min = 1, Max = 50, Default = 1},
    Callback = function(v) hatchAmount = v end,
})

Main:Toggle({
    Title = "Auto Hatch",
    Callback = function(v)
        autoHatching = v
        if v and selectedStar then
            task.spawn(function()
                while autoHatching do
                    pcall(OpenStarRemote.InvokeServer, OpenStarRemote, selectedStar, hatchAmount)
                    task.wait(0.12)
                end
            end)
        end
    end,
})

-- ==================== ENEMY TARGETING ====================
Main:Section({Title = "Enemy Targeting - Auto TP Loop"})

local enemyDrop = Main:Dropdown({
    Title = "Select Enemy Type",
    Values = {},  -- fill with Refresh button
    SearchBarEnabled = true,
    Callback = function(v) selectedEnemy = v end,
})

Main:Button({
    Title = "Refresh Enemy List",
    Callback = function()
        local list = {}
        for _, v in ipairs(EnemiesFolder:GetChildren()) do
            if v:IsA("Model") then table.insert(list, v.Name) end
        end
        table.sort(list)
        enemyDrop:Refresh(list)
        WindUI:Notify({Title = "Refreshed", Content = #list .. " enemies"})
    end,
})

Main:Button({
    Title = "Teleport to Selected",
    Callback = function()
        local target = FindNextAliveEnemy()
        if target then
            TeleportTo(target)
            WindUI:Notify({Title = "Teleported", Content = selectedEnemy})
        else
            WindUI:Notify({Title = "No Enemy", Content = "No alive " .. (selectedEnemy or "enemy") .. " found"})
        end
    end,
})

Main:Toggle({
    Title = "Auto Teleport (loops when dead)",
    Callback = function(v)
        autoTeleporting = v
        if v and selectedEnemy then
            task.spawn(function()
                while autoTeleporting do
                    local target = FindNextAliveEnemy()
                    if target then
                        TeleportTo(target)
                        task.wait(0.8)   -- fast re-check while alive
                    else
                        task.wait(2.5)   -- slower when none alive
                    end
                end
            end)
            WindUI:Notify({Title = "Auto TP ON", Content = "Will loop to next " .. selectedEnemy})
        end
    end,
})

WindUI:Notify({Title = "Loaded!", Content = "TP now searches Mobs + MobSpawns folders!", Duration = 10})
